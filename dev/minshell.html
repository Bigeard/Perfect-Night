<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Perfect Night</title>
    <meta name="title" content="Perfect Night">
    <meta name="description" content="Multi Player Video Game | Perfect Night">
    <meta name="keywords" content="perfectnight, multiplayer, videogame">
    <meta name="viewport" content="width=device-width">
    <link rel="shortcut icon" href="https://www.raylib.com/favicon.ico">

    <style>
        html {
            background: black;
        }

        body {
            margin: 0px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        canvas {
            width: 100%;
        }

        #peerjs {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>

<body>
    <canvas id=canvas oncontextmenu=event.preventDefault() tabindex=-1></canvas>
    <table id="peerjs">
        <tr>
            <td>Status: <span id="status"></span></td>
            <td>Messages: <span id="message"></span></td>
        </tr>
        <tr>
            <td>
                <div style="font-weight: bold;" title="Copy this ID to the input on send.html.">ID:
                    <input type="text" id="receiver-id" disabled>
                </div>
                <button onclick="CopyToClipboard()">Copy ID</button>
            </td>
            <td><input type="text" id="sendMessageBox" placeholder="Enter a message..." /></td>
        </tr>
    </table>

    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script type="text/javascript">
        // RayLib
        var Module = { canvas: document.getElementById('canvas') }

        // PeerJS
        var peerjs = document.getElementById("peerjs");
        togglePeerJs = () => {
            if (peerjs.style.display === "none") {
                peerjs.style.display = "block";
            } else {
                peerjs.style.display = "none";
            }
            return 1;
        }

        (function () {

            var lastPeerId = null;
            var peer = null;
            var peerId = null;
            var conn = null;
            var recvId = document.getElementById("receiver-id");
            var status = document.getElementById("status");
            var message = document.getElementById("message");
            var sendMessageBox = document.getElementById("sendMessageBox");

            CopyToClipboard = () => {
                recvId.select();
                navigator.clipboard.writeText(recvId.value);
            }

            function initialize() {
                peer = new Peer(null, { debug: 2 });

                peer.on('open', function (id) {
                    if (peer.id === null) {
                        console.log('Received null id from peer open');
                        peer.id = lastPeerId;
                    } else {
                        lastPeerId = peer.id;
                    }
                    recvId.value = peer.id;
                    status.innerHTML = "Awaiting connection...";
                });

                peer.on('connection', function (c) {
                    if (conn && conn.open) {
                        c.on('open', function () {
                            c.send("Already connected to another client");
                            setTimeout(function () { c.close(); }, 500);
                        });
                        return;
                    }
                    conn = c;
                    status.innerHTML = "Connected to: " + conn.peer;
                    ready();
                });

                peer.on('disconnected', function () {
                    status.innerHTML = "Connection lost. Please reconnect";
                    peer.id = lastPeerId;
                    peer._lastServerId = lastPeerId;
                    peer.reconnect();
                });

                peer.on('close', function () {
                    conn = null;
                    status.innerHTML = "Connection destroyed. Please refresh";
                });

                peer.on('error', function (err) {
                    console.error(err);
                    alert('' + err);
                });
            };

            function ready() {
                conn.on('data', function (data) {
                    var cueString = "<span class=\"cueMsg\">Cue: </span>";
                    addMessage("<span class=\"peerMsg\">Peer: </span>" + data);
                });
                conn.on('close', function () {
                    status.innerHTML = "Connection reset<br>Awaiting connection...";
                    conn = null;
                });
            }

            function addMessage(msg) {
                var now = new Date();
                var h = now.getHours();
                var m = addZero(now.getMinutes());
                var s = addZero(now.getSeconds());
                if (h > 12) h -= 12;
                else if (h === 0) h = 12;
                function addZero(t) {
                    if (t < 10) t = "0" + t;
                    return t;
                };
                message.innerHTML = "<br><span class=\"msg-time\">" + h + ":" + m + ":" + s + "</span>  -  " + msg + message.innerHTML;
            }

            // Send Message
            sendMessageBox.addEventListener('keypress', function (e) {
                if (e.keyCode === '13') {
                    if (conn && conn.open) {
                        var msg = sendMessageBox.value;
                        sendMessageBox.value = "";
                        conn.send(msg);
                        addMessage("<span class=\"selfMsg\">Self: </span>" + msg);
                    } else {
                        console.error('Connection is closed');
                    }
                }
            });

            initialize();
        })();
    </script>
    {{{ SCRIPT }}}
</body>

</html>