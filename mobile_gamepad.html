<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width">
    <title>Perfect Night - Mobile Gamepad</title>
</head>

<body>
    <table class="control">
        <tr>
            <td>Status: <span id="status"></span></td>
            <td>Messages: <span id="message"></span></td>
        </tr>
        <tr>
            <td>
                <span id="peerId">ID: ...</span>
            </td>
            <td>
                <input type="text" id="sendMessageBox" placeholder="Enter a message..." autofocus="true" />
            </td>
        </tr>
    </table>

    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script type="text/javascript">
        (function () {

            var lastPeerId = null;
            var peer = null; // own peer object
            var conn = null;
            var peerId = document.getElementById("peerId");
            var status = document.getElementById("status");
            var message = document.getElementById("message");
            var sendMessageBox = document.getElementById("sendMessageBox");
            var cueString = "<span class=\"cueMsg\">Cue: </span>";

            function initialize() {
                // Create own peer object with connection to shared PeerJS server
                peer = new Peer(null, { debug: 2 });

                peer.on('open', function (id) {
                    // Workaround for peer.reconnect deleting previous id
                    if (peer.id === null) {
                        console.log('Received null id from peer open');
                        peer.id = lastPeerId;
                    } else {
                        lastPeerId = peer.id;
                    }
                    peerId.innerText = "ID: " + peer.id;
                    const params = new URLSearchParams(document.location.search);
                    const conn_id = params.get("id");
                    if(conn_id) {
                        join(conn_id);
                    } else {
                        console.error("No ID", id);
                    }
                });
                peer.on('connection', function (c) {
                    // Disallow incoming connections
                    c.on('open', function () {
                        c.send("Sender does not accept incoming connections");
                        setTimeout(function () { c.close(); }, 500);
                    });
                });
                peer.on('disconnected', function () {
                    status.innerText = "Connection lost. Please reconnect";
                    // Workaround for peer.reconnect deleting previous id
                    peer.id = lastPeerId;
                    peer._lastServerId = lastPeerId;
                    peer.reconnect();
                });
                peer.on('close', function () {
                    conn = null;
                    status.innerText = "Connection destroyed. Please refresh";
                });
                peer.on('error', function (err) {
                    console.error(err);
                    alert('' + err);
                });
            };

            function join(conn_id) {
                if (conn) {
                    conn.close();
                }
                conn = peer.connect(conn_id, {
                    reliable: true
                });
                conn.on('open', function () {
                    status.innerText = "Connected to: " + conn.peer;
                });
                conn.on('data', function (data) {
                    addMessage("<span class=\"peerMsg\">Peer:</span> " + data);
                });
                conn.on('close', function () {
                    status.innerText = "Connection closed";
                });
            };

            function signal(sigName) {
                if (conn && conn.open) {
                    conn.send(sigName);
                    addMessage(cueString + sigName + " signal sent");
                } else {
                    console.log('Connection is closed');
                }
            }

            function addMessage(msg) {
                var now = new Date();
                var h = now.getHours();
                var m = addZero(now.getMinutes());
                var s = addZero(now.getSeconds());
                if (h > 12) h -= 12;
                else if (h === 0) h = 12;
                function addZero(t) {
                    if (t < 10) t = "0" + t;
                    return t;
                };
                message.innerHTML = "<br><span class=\"msg-time\">" + h + ":" + m + ":" + s + "</span>  -  " + msg + message.innerHTML;
            };

            // Send Message
            sendMessageBox.addEventListener('keypress', function (e) {
                if (e.keyCode == '13') {
                    if (conn && conn.open) {
                        var msg = sendMessageBox.value;
                        sendMessageBox.value = "";
                        conn.send(msg);
                        addMessage("<span class=\"selfMsg\">Self: </span> " + msg);
                    } else {
                        console.log('Connection is closed');
                    }
                }
            });
            initialize();
        })();
    </script>
    <div id="zone_joystick"></div>
    <script src="./nipplejs.js"></script>
    <script>
        var manager = nipplejs.create({
            zone: document.getElementById('zone_joystick'),
            mode: 'static',
            position: { left: '50%', top: '50%' },
            color: 'red'
        });
    </script>
</body>

</html>